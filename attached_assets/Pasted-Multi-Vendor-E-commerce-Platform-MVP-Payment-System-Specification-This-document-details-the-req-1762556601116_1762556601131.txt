Multi-Vendor E-commerce Platform (MVP) - Payment System Specification
This document details the required features and implementation steps for handling secure, automated, and dynamic split payments across the marketplace using Paystack.
Objective: To ensure that every transaction automatically deducts the Platform Commission and Paystack Fees, and securely routes the remaining funds to the correct Vendor (Subaccount).
1. Core Data Model Requirements
The following entities must be created and linked within the platform's database (e.g., Firestore):
1.1. Vendor Profile (Vendors Collection)
Field	Type	Description
vendorId	String (Unique)	The platform's unique ID for the vendor/store.
storeName	String	The public name of the vendor's shop.
paystackSubaccountId	String (Required)	Crucial: The unique ID generated by Paystack upon subaccount creation.
payoutType	String	E.g., 'Bank Account', 'Mobile Money (MoMo)'.
payoutDetails	Map/Object	Stores necessary MoMo number or Bank details (Account Number, Bank Code, Name).
isPayoutVerified	Boolean	Status of Paystack verification for the subaccount.
1.2. Platform Settings (Settings Document)
Field	Type	Description
platformCommissionPercentage	Number	Dynamic Commission Field: The percentage the admin sets (e.g., 2.0 for 2%). This value is fetched before initiating any transaction.
2. Vendor Onboarding & Paystack Subaccount Creation
The system must guide every new vendor through a process to collect and verify their payment information for automated payouts.
A. Vendor Input Interface
1.	Create a form for vendors to input their payout details, supporting:
o	Bank Account: Account Name, Account Number, Bank Name/Code.
o	Mobile Money (MoMo/Ghana): Full Name, Mobile Number, Provider (e.g., MTN, Vodafone).
B. Automated Subaccount Generation
1.	Upon submission, the platform must immediately call the Paystack API (using the backend/AI Builder service) to create a Subaccount for that vendor.
o	API Endpoint: Paystack Subaccounts API (/subaccount).
2.	The API request must include the vendor's name and collected payout details (bank or MoMo information).
3.	Paystack returns a unique subaccount_code (e.g., ACCT_xxxxxxxx).
4.	The system MUST store this subaccount_code in the vendor's profile as the paystackSubaccountId.
Note: The vendor's Store ID is now permanently linked to the Paystack Subaccount ID.
3. Dynamic Split Payment Flow (CRITICAL)
This flow dictates how funds are automatically routed during a successful checkout.
A. Pre-Transaction Logic (Backend/Service)
1.	When a customer clicks "Pay," the system calculates the final amount due.
2.	Fetch Commission Rate: The system fetches the current platformCommissionPercentage from the Settings document.
3.	Identify Vendor: Identify the vendorId associated with the product(s) in the cart.
4.	Retrieve Subaccount: Retrieve the paystackSubaccountId of the vendor from the Vendors collection.
5.	Calculate Split Ratio:
o	Vendor Share: 100% - platformCommissionPercentage.
o	Example (2% commission): Vendor Share is 98%.
o	Note: Paystack handles the conversion to the ratio format required for the API.
B. Paystack Transaction Initiation (API Call)
The platform initiates the transaction using the Paystack API (e.g., /transaction/initialize). The request payload MUST include the split object to define the payout:
{
  "email": "customer@email.com",
  "amount": 50000,  // e.g., GHS 500.00 in Kobo/Pesewas
  "metadata": {
      "vendor_id": "VEND001",
      "store_id": "SHOES_R_US"
  },
  "subaccounts": [
    {
      "subaccount": "ACCT_xxxxxxxx", // Vendor's paystackSubaccountId
      "share_percent": 98           // 100 - 2% (Platform Commission)
    }
  ],
  "bearer": "subaccount" // Crucial: Specifies who pays the Paystack fee.
}
Key Directives for the AI Builder:
1.	subaccounts Array: Define the vendor's subaccount and their calculated share (share_percent).
2.	bearer Field: The bearer field MUST be set to "subaccount" (or the platform account, depending on your business decision). Setting it to subaccount means the vendor pays the Paystack transaction fee from their 98% share. If you set it to account (your platform), you will pay the fees. For standard marketplaces, set it to subaccount to pass fees to the vendor.
3.	Dynamic Share: The share_percent must be calculated dynamically based on the Admin-defined platformCommissionPercentage.
4. Admin Dashboard Management Interface
The platform admin requires a dedicated interface to manage the commission and monitor transactions.
A. Dynamic Commission Control
1.	Create a clearly labeled section/field in the Admin Dashboard linked to the Settings collection.
2.	The admin must be able to Input, Validate, and Save a new platformCommissionPercentage (e.g., a number between 0.0 and 10.0).
3.	All subsequent transactions must immediately use this updated percentage in the split calculation (Section 3.A.2).
B. Transaction Reporting
1.	The admin dashboard must display a list of all transactions.
2.	Each record must clearly show the three components of the split:
o	Total Amount
o	Paystack Fee (Calculated by Paystack, retrieved on webhook)
o	Platform Commission (Calculated based on the dynamic rate)
o	Vendor Payout (The final amount sent to the subaccount)
5. Paystack Webhook Handling
A serverless function or backend endpoint is required to receive real-time updates from Paystack.
1.	Endpoint: Create a secure endpoint to receive POST requests from Paystack (e.g., /webhooks/paystack).
2.	Validation: MUST validate the incoming request using the X-Paystack-Signature header to ensure security.
3.	Event Handling: Listen for the charge.success event.
4.	Transaction Finalization: Upon receiving a verified success event, record the final transaction details, including Paystack's exact fee amount and the specific split amounts (which Paystack includes in the webhook payload).
This detailed specification ensures the AI builder has all the necessary technical and business logic requirements to implement a secure, automated, and dynamic split-payment system from the start.
